<!DOCTYPE html>
<html lang="zh-Hant">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>äº’å‹•ç§¤é¢å­¸ç¿’æ¿</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
    
    <!-- PWA -->
    <link rel="manifest" href="./manifest.json">
    <meta name="theme-color" content="#3b82f6">
    
    <style>
        body { font-family: 'Inter', sans-serif; }
        .line-segment { stroke-linecap: round; }
        .needle { /* transition: transform 0.5s ease-in-out; <-- ç§»é™¤CSSå‹•ç•«ï¼Œæ”¹ç”¨JSæ§åˆ¶ */ }
        .confetti-container {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            pointer-events: none;
            overflow: hidden;
            z-index: 1000;
        }
        .confetti {
            position: absolute;
            width: 10px;
            height: 10px;
            background-color: #f0f;
            animation: fall linear forwards;
            opacity: 0;
        }
        @keyframes fall {
            0% { transform: translateY(-100px) rotateZ(0deg); opacity: 1; }
            100% { transform: translateY(100vh) rotateZ(720deg); opacity: 0; }
        }

        /* --- ç ç¢¼å’Œæ‹–æ›³æ¨£å¼ --- */
        #weights-home {
            display: flex;
            flex-wrap: wrap;
            gap: 10px;
            padding: 10px;
            background-color: #f3f4f6;
            border-radius: 8px;
            justify-content: center;
        }
        #on-scale-area {
            position: absolute;
            top: 5%; /* ä½æ–¼ç§¤é¢ä¸Šæ–¹å¤–éƒ¨ */
            left: 50%;
            transform: translateX(-50%);
            width: 200px;
            min-height: 80px;
            background-color: rgba(255, 255, 255, 0.7);
            border: 2px dashed #9ca3af;
            border-radius: 8px;
            display: flex;
            flex-wrap: wrap;
            align-content: flex-start;
            gap: 5px;
            padding: 5px;
            z-index: 10;
            overflow-y: auto; /* å¦‚æœç ç¢¼å¤ªå¤šå¯ä»¥æ»¾å‹• */
        }
        .draggable-weight {
            width: 45px;
            height: 45px;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            color: white;
            font-weight: bold;
            font-size: 0.9rem;
            cursor: grab;
            user-select: none;
            border: 2px solid rgba(0,0,0,0.2);
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
            /* ç”¨æ–¼è‡ªè£½ç ç¢¼åœ–ç‰‡ */
            background-size: cover;
            background-position: center;
            /* è®“æ–‡å­—æœ‰æé‚Šï¼Œåœ¨æ·±è‰²åœ–ç‰‡ä¸Šä¹Ÿèƒ½çœ‹è¦‹ */
            text-shadow: -1px -1px 0 #000, 1px -1px 0 #000, -1px 1px 0 #000, 1px 1px 0 #000;
        }
        .dragging {
            opacity: 0.5;
            cursor: grabbing;
        }
        .on-scale {
            width: 30px; /* æ”¾åœ¨ç§¤ç›¤ä¸Šçš„ç ç¢¼ç¸®å°ä¸€é» */
            height: 30px;
            font-size: 0.75rem;
        }
        
        /* æŒ‘æˆ°æ¨¡å¼ä¸­éš±è—ç ç¢¼å€ */
        .challenge-mode-active #weights-container,
        .challenge-mode-active #on-scale-area {
            display: none;
        }
        
        /* æŒ‘æˆ°æ¨¡å¼ä¸­éš±è—æ•¸å­—é¡¯ç¤º */
        .challenge-mode-active #digital-display-container {
            display: none;
        }
        
        /* æŒ‘æˆ°æ¨¡å¼ä¸­é¡¯ç¤ºè¼¸å…¥å€ */
        #challenge-inputs {
            display: none;
        }
        .challenge-mode-active #challenge-inputs {
            display: block;
        }
        
        /* æŒ‘æˆ°æ¨¡å¼ä¸­éš±è—è»Œè·¡é–‹é—œ */
        .challenge-mode-active #track-switch-container {
            display: none;
        }
        
        /* å½ˆçª—æ¨£å¼ */
        .app-modal-hidden {
            display: none;
        }

    </style>
</head>
<body class="bg-gray-100 text-gray-900 min-h-screen flex items-center justify-center p-4">

    <div id="app-container" class="flex flex-col lg:flex-row bg-white shadow-xl rounded-lg overflow-hidden max-w-6xl w-full">

        <!-- å·¦å´ï¼šç§¤é¢å€åŸŸ -->
        <div class="relative w-full lg:w-3/5 p-4 flex items-center justify-center bg-gray-50">
            <div class="relative w-full max-w-md aspect-square bg-gray-200 rounded-full shadow-inner flex items-center justify-center" style="transform: scale(0.7);">
                <!-- ç§¤é¢ SVG -->
                <svg id="scaleDial" class="w-full h-full" viewBox="0 0 200 215">
                    <!-- æ–°å¢ï¼šç§¤çš„åº•åº§ï¼ˆæœ€åº•å±¤ï¼‰ -->
                    <rect x="70" y="195" width="60" height="5" fill="#9ca3af"/>
                    <polygon points="70,200 130,200 140,215 60,215" fill="#a1a1aa"/>
                    
                    <!-- åœ“å½¢éŒ¶ç›¤ -->
                    <circle cx="100" cy="100" r="95" fill="white" stroke="#ccc" stroke-width="2"/>

                    <!-- åˆ»åº¦ -->
                    <g id="dialMarks">
                        <!-- å‹•æ…‹ç”Ÿæˆåˆ»åº¦ -->
                    </g>

                    <!-- é‡é‡æ¨™ç¤º -->
                    <text x="100" y="30" text-anchor="middle" font-size="12" fill="#333" transform="rotate(0 100 100)">
                        <tspan x="100">0</tspan>
                        <tspan x="100" dy="1.2em">3kg</tspan>
                        <tspan x="103" dy="1.5em" font-size="7">æœ€å¤§è¨ˆé‡ 3kg</tspan>
                        <tspan x="100" dy="1.2em" font-size="7">æœ€å°åˆ»åº¦ 10g</tspan>
                    </text>
                    <text x="100" y="45" text-anchor="middle" dominant-baseline="middle" font-size="12" fill="#333" transform="rotate(120 100 100)">1kg</text>
                    <text x="100" y="45" text-anchor="middle" dominant-baseline="middle" font-size="12" fill="#333" transform="rotate(240 100 100)">2kg</text>

                    <!-- æ–°å¢ 500g æ¨™ç¤º -->
                    <text x="100" y="45" text-anchor="middle" dominant-baseline="middle" font-size="10" fill="#333" transform="rotate(60 100 100)">500g</text>
                    <text x="100" y="45" text-anchor="middle" dominant-baseline="middle" font-size="10" fill="#333" transform="rotate(180 100 100)">1kg500g</text>
                    <text x="100" y="45" text-anchor="middle" dominant-baseline="middle" font-size="10" fill="#333" transform="rotate(300 100 100)">2kg500g</text>

                    <!-- è»Œè·¡ (æ‰‡å½¢) -->
                    <path id="weightTrack" d="" fill="rgba(239, 68, 68, 0.3)" stroke-width="0"/>
                    
                    <!-- æŒ‡é‡ -->
                    <g id="needleGroup" class="cursor-grab active:cursor-grabbing">
                        <line x1="100" y1="100" x2="100" y2="10" stroke="red" stroke-width="1.5" class="line-segment needle" id="weightNeedle" transform="rotate(0 100 100)"/>
                        <circle cx="100" cy="100" r="5" fill="red" stroke="white" stroke-width="1"/>
                    </g>
                </svg>
            </div>

            <!-- ç§¤ç›¤ (Drop Zone) - æ–°ä½ç½® -->
            <div id="on-scale-area" title="å°‡ç ç¢¼æ‹–åˆ°é€™è£¡"></div>
        </div>

        <!-- å³å´ï¼šæ§åˆ¶é¢æ¿ -->
        <div class="w-full lg:w-2/5 p-6 bg-white flex flex-col justify-between">
            <div>
                <h1 class="text-3xl font-bold mb-4 text-center lg:text-left">ç§¤é¢å­¸ç¿’æ¿</h1>

                <!-- æ•¸å­—é¡¯ç¤º (å·²åŠ ä¸Š ID) -->
                <div id="digital-display-container" class="mb-6 bg-blue-100 p-4 rounded-lg flex items-center justify-center flex-wrap gap-x-4">
                    <span id="digitalKgDisplay" class="text-5xl font-extrabold text-blue-800 tracking-tight">0 å…¬æ–¤</span>
                    <span id="digitalGramDisplay" class="text-4xl font-bold text-blue-600 tracking-tight">0 å…¬å…‹</span>
                </div>

                <!-- æŒ‘æˆ°æ¨¡å¼é¡Œç›® -->
                <div id="challenge-question-reading" class="mb-4 text-center text-lg font-semibold text-gray-700 hidden">
                    è«‹è®€å‡ºç§¤é¢ä¸Šçš„é‡é‡ï¼š
                </div>
                
                <!-- æŒ‘æˆ°æ¨¡å¼è¼¸å…¥ -->
                <div id="challenge-inputs" class="mb-4 hidden">
                    <div class="flex gap-4">
                        <input type="number" id="challengeKgInput" placeholder="å…¬æ–¤" class="w-1/2 p-2 border rounded-lg text-lg text-center">
                        <input type="number" id="challengeGInput" placeholder="å…¬å…‹" class="w-1/2 p-2 border rounded-lg text-lg text-center">
                    </div>
                </div>

                <!-- ç ç¢¼å€å¡Š (æ–°å¢ID) -->
                <div id="weights-container" class="mb-4">
                    <h2 class="text-lg font-semibold text-gray-700 mb-2 text-center">ç ç¢¼å€ï¼ˆå¯ç„¡é™æ‹–æ›³ï¼‰</h2>
                    <div id="weights-home">
                        <div class="draggable-weight" data-weight="500" style="background-color: #ef4444;" title="500g">500g</div>
                        <div class="draggable-weight" data-weight="100" style="background-color: #f97316;" title="100g">100g</div>
                        <div class="draggable-weight" data-weight="50" style="background-color: #eab308;" title="50g">50g</div>
                        <div class="draggable-weight" data-weight="10" style="background-color: #22c55e;" title="10g">10g</div>
                        <!-- 1g ç ç¢¼å·²ç§»é™¤ -->
                    </div>
                    <!-- ä¿®æ”¹ï¼šè‡ªè£½ç ç¢¼æŒ‰éˆ• + æ¸…é™¤æŒ‰éˆ• -->
                    <div class="flex gap-2 mt-2">
                        <button id="addWeightBtn" class="w-1/2 bg-blue-500 hover:bg-blue-600 text-white font-semibold py-2 px-4 rounded-lg shadow-md transition duration-200">+ è‡ªè£½ç ç¢¼</button>
                        <button id="clearCustomWeightsBtn" class="w-1/2 bg-gray-400 hover:bg-gray-500 text-white font-semibold py-2 px-4 rounded-lg shadow-md transition duration-200">æ¸…é™¤è‡ªè£½</button>
                    </div>
                </div>

                <!-- æŒ‰éˆ• -->
                <button id="challengeBtn" class="w-full bg-green-600 hover:bg-green-700 text-white font-bold py-4 px-4 rounded-lg shadow-lg transition duration-200 text-lg mb-4">ğŸ† é–‹å§‹æŒ‘æˆ° (è®€é‡é‡)</button>
                <button id="submitAnswerBtn" class="w-full bg-indigo-600 hover:bg-indigo-700 text-white font-bold py-4 px-4 rounded-lg shadow-lg transition duration-200 text-lg hidden">æäº¤ç­”æ¡ˆ</button>

                <!-- å›é¥‹è¨Šæ¯ -->
                <div id="feedbackMessage" class="mt-4 text-center text-2xl font-bold app-modal-hidden"></div>

                <!-- é¸é …é–‹é—œ -->
                <div class="mt-6 border-t border-gray-200 pt-6">
                    <!-- è»Œè·¡é–‹é—œ -->
                    <div id="track-switch-container" class="flex items-center justify-between mb-4">
                        <span class="text-lg text-gray-700">è»Œè·¡</span>
                        <label class="inline-flex relative items-center cursor-pointer">
                            <input type="checkbox" id="trackToggle" class="sr-only peer">
                            <div class="w-11 h-6 bg-gray-200 rounded-full peer peer-checked:after:translate-x-full peer-checked:after:border-white after:content-[''] after:absolute after:top-0.5 after:left-[2px] after:bg-white after:border-gray-300 after:border after:rounded-full after:h-5 after:w-5 after:transition-all peer-checked:bg-blue-600"></div>
                        </label>
                    </div>
                    <div class="flex items-center justify-between mb-4">
                        <span class="text-lg text-gray-700">éŸ³æ•ˆ</span>
                        <label class="inline-flex relative items-center cursor-pointer">
                            <input type="checkbox" id="soundToggle" class="sr-only peer" checked>
                            <div class="w-11 h-6 bg-gray-200 rounded-full peer peer-checked:after:translate-x-full peer-checked:after:border-white after:content-[''] after:absolute after:top-0.5 after:left-[2px] after:bg-white after:border-gray-300 after:border after:rounded-full after:h-5 after:w-5 after:transition-all peer-checked:bg-blue-600"></div>
                        </label>
                    </div>
                    <!-- é‡ç½®æŒ‰éˆ• -->
                    <div class="flex items-center justify-between mb-4">
                        <span class="text-lg text-gray-700">é‡ç½®ç§¤é¢</span>
                        <button id="resetBtn" class="bg-red-500 hover:bg-red-600 text-white font-semibold py-2 px-4 rounded-lg shadow-md transition duration-200">å…¨éƒ¨æ¸…é™¤</button>
                    </div>
                </div>
            </div>

            <!-- å¹«åŠ©æŒ‰éˆ• -->
            <div class="mt-8 text-center text-gray-500 text-sm">
                <button id="helpBtn" class="text-blue-500 hover:text-blue-600 focus:outline-none flex items-center justify-center mx-auto">
                    <svg class="w-5 h-5 mr-1" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M13 16h-1v-4h-1m1-4h.01M21 12a9 9 0 11-18 0 9 9 0 0118 0z"></path></svg>
                    <span>å¹«åŠ©</span>
                </button>
            </div>
        </div>
    </div>

    <!-- çµæœå½ˆçª— -->
    <div id="resultModal" class="fixed inset-0 bg-gray-800 bg-opacity-75 items-center justify-center z-50 app-modal-hidden">
        <div class="bg-white p-8 rounded-lg shadow-xl text-center max-w-sm w-full">
            <h2 class="text-3xl font-bold mb-4" id="resultTitle">æŒ‘æˆ°å®Œæˆï¼</h2>
            <p class="text-xl mb-6">æ‚¨çš„åˆ†æ•¸ï¼š<span id="finalScore" class="font-extrabold text-blue-600"></span> / <span id="totalQuestions" class="font-extrabold text-gray-700"></span></p>
            <button id="closeResultModalBtn" class="bg-blue-500 hover:bg-blue-600 text-white font-bold py-3 px-6 rounded-lg">å†ç©ä¸€æ¬¡</button>
        </div>
    </div>

    <!-- å¹«åŠ©å½ˆçª— -->
    <div id="helpModal" class="fixed inset-0 bg-gray-800 bg-opacity-75 items-center justify-center z-50 app-modal-hidden">
        <div class="bg-white p-8 rounded-lg shadow-xl max-w-md w-full">
            <h2 class="text-2xl font-bold mb-4">å¦‚ä½•ä½¿ç”¨ï¼Ÿ</h2>
            <ul class="list-disc list-inside text-gray-700 space-y-2">
                <li><strong class="text-blue-600">è‡ªç”±æ¨¡å¼ï¼š</strong>å¾å³å´ã€Œç ç¢¼å€ã€æ‹–æ›³ç ç¢¼åˆ°å·¦ä¸Šè§’çš„ã€Œç§¤ç›¤ã€ä¸Šï¼Œç§¤é¢æœƒé¡¯ç¤ºç¸½é‡é‡ã€‚</li>
                <li><strong class="text-blue-600">è‡ªè£½ç ç¢¼ï¼š</strong>é»æ“Šã€Œ+ è‡ªè£½ç ç¢¼ã€ï¼Œä¸Šå‚³åœ–ç‰‡ä¸¦è¨­å®šé‡é‡ï¼Œå³å¯å»ºç«‹æ–°çš„å¯æ‹–æ›³ç‰©å“ã€‚æ‚¨çš„è‡ªè£½ç‰©å“æœƒè¢«å„²å­˜èµ·ä¾†ï¼</li>
                <li><strong class="text-green-600">æŒ‘æˆ°æ¨¡å¼ï¼š</strong>é»æ“Šã€ŒğŸ† é–‹å§‹æŒ‘æˆ°ã€ï¼ŒæŒ‡é‡æœƒè‡ªå‹•è½‰åˆ°ä¸€å€‹é‡é‡ï¼Œè«‹åœ¨è¼¸å…¥æ¡†ä¸­å¡«å…¥æ‚¨åˆ¤è®€çš„å…¬æ–¤å’Œå…¬å…‹æ•¸ã€‚</li>
                <li><strong class="text-red-600">é‡ç½®æŒ‰éˆ•ï¼š</strong>é»æ“Šã€Œå…¨éƒ¨æ¸…é™¤ã€ä¾†æ¸…ç©ºç§¤ç›¤å’Œé‡é‡ã€‚</li>
                <li><strong class="text-gray-600">æ¸…é™¤è‡ªè£½ï¼š</strong>é»æ“Šå¯åˆªé™¤æ‰€æœ‰æ‚¨å„²å­˜çš„è‡ªè£½ç ç¢¼ã€‚</li>
                <li><strong class="text-gray-600">è»Œè·¡é–‹é—œï¼š</strong>æ‰“é–‹å¯é¡¯ç¤ºé‡é‡çš„æ‰‡å½¢é¢ç©ã€‚</li>
                <li><strong class="text-gray-600">éŸ³æ•ˆé–‹é—œï¼š</strong>æ§åˆ¶æ˜¯å¦æ’­æ”¾éŸ³æ•ˆã€‚</li>
            </ul>
            <button id="closeHelpModalBtn" class="mt-6 bg-blue-500 hover:bg-blue-600 text-white font-bold py-3 px-6 rounded-lg w-full">æˆ‘çŸ¥é“äº†</button>
        </div>
    </div>

    <!-- æ–°å¢ï¼šè‡ªè£½ç ç¢¼å½ˆçª— -->
    <div id="customWeightModal" class="fixed inset-0 bg-gray-800 bg-opacity-75 items-center justify-center z-50 app-modal-hidden">
        <div class="bg-white p-8 rounded-lg shadow-xl max-w-md w-full">
            <h2 class="text-2xl font-bold mb-4">å»ºç«‹è‡ªè£½ç ç¢¼</h2>
            
            <div class="mb-4">
                <label class="block text-gray-700 text-sm font-bold mb-2" for="customWeightName">
                    ç‰©å“åç¨± (ä¾‹å¦‚ï¼šæ›¸æœ¬)
                </label>
                <input id="customWeightName" class="shadow appearance-none border rounded w-full py-2 px-3 text-gray-700 leading-tight focus:outline-none focus:shadow-outline" type="text" placeholder="æ›¸æœ¬">
            </div>

            <div class="mb-4">
                <label class="block text-gray-700 text-sm font-bold mb-2" for="customWeightGrams">
                    é‡é‡ (å…¬å…‹)
                </label>
                <input id="customWeightGrams" class="shadow appearance-none border rounded w-full py-2 px-3 text-gray-700 leading-tight focus:outline-none focus:shadow-outline" type="number" placeholder="800">
            </div>

            <div class="mb-4">
                <label class="block text-gray-700 text-sm font-bold mb-2" for="customWeightImage">
                    ä¸Šå‚³åœ–ç‰‡
                </label>
                <input id="customWeightImageInput" class="shadow appearance-none border rounded w-full py-2 px-3 text-gray-700 leading-tight focus:outline-none focus:shadow-outline" type="file" accept="image/*">
            </div>

            <div class="mb-6 text-center">
                <label class="block text-gray-700 text-sm font-bold mb-2">
                    åœ–ç‰‡é è¦½
                </label>
                <div id="imagePreview" class="w-32 h-32 bg-gray-200 rounded-full mx-auto border border-gray-300" style="background-size: cover; background-position: center;"></div>
            </div>

            <div class="flex items-center justify-between">
                <button id="saveWeightBtn" class="bg-blue-500 hover:bg-blue-600 text-white font-bold py-2 px-4 rounded focus:outline-none focus:shadow-outline" type="button">
                    å„²å­˜ç ç¢¼
                </button>
                <button id="closeModalBtn" class="bg-gray-500 hover:bg-gray-700 text-white font-bold py-2 px-4 rounded focus:outline-none focus:shadow-outline" type="button">
                    å–æ¶ˆ
                </button>
            </div>
        </div>
    </div>


    <!-- å½©èŠ±å®¹å™¨ -->
    <div class="confetti-container" id="confettiContainer"></div>

    <script>
    document.addEventListener('DOMContentLoaded', () => {

        // --- è®Šæ•¸å®£å‘Š ---
        let scaleDial, needleGroup, weightNeedle, digitalKgDisplay, digitalGramDisplay,
            challengeBtn, submitAnswerBtn, feedbackMessage, soundToggle, helpBtn,
            helpModal, closeHelpModalBtn, resultModal, resultTitle, finalScore,
            totalQuestions, closeResultModalBtn, confettiContainer, resetBtn,
            appContainer, weightsHome, onScaleArea, challengeQuestionReading,
            challengeKgInput, challengeGInput, trackToggle, weightTrack;
            
        // è‡ªè£½ç ç¢¼ç›¸é—œ
        let addWeightBtn, customWeightModal, closeModalBtn, saveWeightBtn,
            customWeightName, customWeightGrams, customWeightImageInput, imagePreview,
            clearCustomWeightsBtn; // <-- æ–°å¢æ¸…é™¤æŒ‰éˆ•è®Šæ•¸

        // --- è®Šæ•¸è³¦å€¼ ---
        scaleDial = document.getElementById('scaleDial');
        needleGroup = document.getElementById('needleGroup');
        weightNeedle = document.getElementById('weightNeedle');
        digitalKgDisplay = document.getElementById('digitalKgDisplay');
        digitalGramDisplay = document.getElementById('digitalGramDisplay');
        challengeBtn = document.getElementById('challengeBtn');
        submitAnswerBtn = document.getElementById('submitAnswerBtn');
        feedbackMessage = document.getElementById('feedbackMessage');
        soundToggle = document.getElementById('soundToggle');
        helpBtn = document.getElementById('helpBtn');
        helpModal = document.getElementById('helpModal');
        closeHelpModalBtn = document.getElementById('closeHelpModalBtn');
        resultModal = document.getElementById('resultModal');
        resultTitle = document.getElementById('resultTitle');
        finalScore = document.getElementById('finalScore');
        totalQuestions = document.getElementById('totalQuestions');
        closeResultModalBtn = document.getElementById('closeResultModalBtn');
        confettiContainer = document.getElementById('confettiContainer');
        resetBtn = document.getElementById('resetBtn');
        appContainer = document.getElementById('app-container');
        
        // æ‹–æ›³ç›¸é—œ
        weightsHome = document.getElementById('weights-home');
        onScaleArea = document.getElementById('on-scale-area');
        
        // æŒ‘æˆ°æ¨¡å¼ (è®€å–) ç›¸é—œ
        challengeQuestionReading = document.getElementById('challenge-question-reading');
        challengeKgInput = document.getElementById('challengeKgInput');
        challengeGInput = document.getElementById('challengeGInput');
        
        // è»Œè·¡ç›¸é—œ
        trackToggle = document.getElementById('trackToggle');
        weightTrack = document.getElementById('weightTrack');
        
        // è‡ªè£½ç ç¢¼ç›¸é—œ
        addWeightBtn = document.getElementById('addWeightBtn');
        customWeightModal = document.getElementById('customWeightModal');
        closeModalBtn = document.getElementById('closeModalBtn');
        saveWeightBtn = document.getElementById('saveWeightBtn');
        customWeightName = document.getElementById('customWeightName');
        customWeightGrams = document.getElementById('customWeightGrams');
        customWeightImageInput = document.getElementById('customWeightImageInput');
        imagePreview = document.getElementById('imagePreview');
        clearCustomWeightsBtn = document.getElementById('clearCustomWeightsBtn'); // <-- è³¦å€¼
        
        let draggedItem = null; 
        let useTrack = false;

        // --- LocalStorage çš„ Key ---
        const CUSTOM_WEIGHTS_STORAGE_KEY = 'customScaleWeights';

        // --- å¸¸æ•¸ ---
        const DIAL_RADIUS = 95;
        const CENTER_X = 100;
        const CENTER_Y = 100;
        const MAX_WEIGHT_GRAMS = 3000;
        const TOTAL_DEGREES = 360;
        const DEGREES_PER_GRAM = TOTAL_DEGREES / MAX_WEIGHT_GRAMS; // 360 / 3000 = 0.12 åº¦/å…¬å…‹

        // --- ç‹€æ…‹è®Šæ•¸ ---
        let currentGrams = 0;
        let isChallengeMode = false;
        let challengeQuestions = [];
        let currentQuestionIndex = 0;
        let score = 0;
        let audioContext;
        let useSound = true;
        let challengeTargetGrams = 0; 
        let currentAnimationInterval = null; 
        let imagePreviewUrl = null; 

        // --- éŸ³æ•ˆç”Ÿæˆå™¨ ---
        function createAudioContext() {
            if (!audioContext) {
                audioContext = new (window.AudioContext || window.webkitAudioContext)();
            }
        }

        function playSound(type) {
            if (!useSound || !audioContext) return;

            const oscillator = audioContext.createOscillator();
            const gainNode = audioContext.createGain();

            oscillator.connect(gainNode);
            gainNode.connect(audioContext.destination);

            let frequency, duration, volume;

            switch (type) {
                case 'correct':
                    frequency = 880; duration = 0.1; volume = 0.2;
                    break;
                case 'wrong':
                    frequency = 220; duration = 0.2; volume = 0.2;
                    break;
                case 'click': // ç”¨æ–¼æ”¾ç½®ç ç¢¼
                    frequency = 660; duration = 0.05; volume = 0.1;
                    break;
                case 'success_jingle':
                    playSuccessJingle();
                    return;
                default:
                    return;
            }

            oscillator.type = 'sine';
            oscillator.frequency.value = frequency;
            gainNode.gain.setValueAtTime(volume, audioContext.currentTime);
            gainNode.gain.exponentialRampToValueAtTime(0.00001, audioContext.currentTime + duration);

            oscillator.start();
            oscillator.stop(audioContext.currentTime + duration);
        }

        function playSuccessJingle() {
            if (!useSound || !audioContext) return;
            const notes = [
                { freq: 523.25, dur: 0.1 }, { freq: 659.25, dur: 0.1 },
                { freq: 783.99, dur: 0.15 },{ freq: 1046.50, dur: 0.2 },
            ];
            let startTime = audioContext.currentTime;
            notes.forEach(note => {
                const oscillator = audioContext.createOscillator();
                const gainNode = audioContext.createGain();
                oscillator.connect(gainNode);
                gainNode.connect(audioContext.destination);
                oscillator.type = 'triangle';
                oscillator.frequency.value = note.freq;
                gainNode.gain.setValueAtTime(0.3, startTime);
                gainNode.gain.exponentialRampToValueAtTime(0.00001, startTime + note.dur);
                oscillator.start(startTime);
                oscillator.stop(startTime + note.dur);
                startTime += note.dur + 0.02;
            });
        }

        // --- å½©èŠ±æ•ˆæœ ---
        function launchConfetti() {
            for (let i = 0; i < 50; i++) {
                const confetti = document.createElement('div');
                confetti.classList.add('confetti');
                confetti.style.left = Math.random() * 100 + '%';
                confetti.style.backgroundColor = `hsl(${Math.random() * 360}, 100%, 50%)`;
                confetti.style.animationDuration = (Math.random() * 2 + 3) + 's';
                confetti.style.animationDelay = (Math.random() * 0.5) + 's';
                confetti.style.transform = `translateX(${Math.random() * 200 - 100}px) translateY(${Math.random() * -100}px) rotateZ(${Math.random() * 360}deg)`;
                confettiContainer.appendChild(confetti);
                confetti.addEventListener('animationend', () => confetti.remove());
            }
        }

        // --- ç§¤é¢ç¹ªè£½ ---
        function drawScaleMarks() {
            const dialMarks = document.getElementById('dialMarks');
            dialMarks.innerHTML = '';
            const smallMarkLength = 4;
            const mediumMarkLength = 7;
            const largeMarkLength = 10;
            const extraLargeMarkLength = 31.35; // 0.33 * 95
            const markStrokeWidth = 0.5;
            const totalMarks = 300; // 360 / 1.2 = 300

            for (let i = 0; i < totalMarks; i++) {
                const angle = i * 1.2;
                let length = smallMarkLength;
                let stroke = '#999';

                if (i % 50 === 0) { // æ¯ 60 åº¦ (50 * 1.2)
                    length = extraLargeMarkLength;
                    stroke = 'red';
                } else if (i % 10 === 0) { // æ¯ 12 åº¦ (10 * 1.2)
                    length = largeMarkLength;
                    stroke = '#333';
                } else if (i % 5 === 0) { // æ¯ 6 åº¦ (5 * 1.2)
                    length = mediumMarkLength;
                    stroke = '#666';
                }

                const line = document.createElementNS("http://www.w3.org/2000/svg", "line");
                line.setAttribute('x1', CENTER_X);
                line.setAttribute('y1', CENTER_Y - DIAL_RADIUS);
                line.setAttribute('x2', CENTER_X);
                line.setAttribute('y2', CENTER_Y - DIAL_RADIUS + length);
                line.setAttribute('stroke', stroke);
                line.setAttribute('stroke-width', markStrokeWidth);
                line.setAttribute('class', 'dial-mark');
                line.setAttribute('transform', `rotate(${angle} ${CENTER_X} ${CENTER_Y})`);
                dialMarks.appendChild(line);
            }
        }
        
        // --- è»Œè·¡ç¹ªè£½ ---
        function polarToCartesian(centerX, centerY, radius, angleInDegrees) {
            var angleInRadians = (angleInDegrees - 90) * Math.PI / 180.0;
            return {
                x: centerX + (radius * Math.cos(angleInRadians)),
                y: centerY + (radius * Math.sin(angleInRadians))
            };
        }

        function drawTrack(degrees) {
            if (!useTrack || degrees <= 0) {
                weightTrack.setAttribute("d", ""); // éš±è—è»Œè·¡
                return;
            }
            
            const angle = Math.min(degrees, 359.99); 
            
            const start = polarToCartesian(CENTER_X, CENTER_Y, DIAL_RADIUS, 0);
            const end = polarToCartesian(CENTER_X, CENTER_Y, DIAL_RADIUS, angle);
            const largeArcFlag = angle > 180 ? "1" : "0";

            const d = [
                "M", CENTER_X, CENTER_Y, 
                "L", start.x, start.y,
                "A", DIAL_RADIUS, DIAL_RADIUS, 0, largeArcFlag, 1, end.x, end.y,
                "Z" // close path
            ].join(" ");

            weightTrack.setAttribute("d", d);
        }

        // --- æŒ‡é‡èˆ‡é¡¯ç¤ºæ›´æ–° ---
        function updateNeedleAndDisplay(grams) {
            currentGrams = grams;
            const degrees = (grams * DEGREES_PER_GRAM) % 360;
            
            // 1. æ›´æ–°æŒ‡é‡
            weightNeedle.setAttribute('transform', `rotate(${degrees} ${CENTER_X} ${CENTER_Y})`);

            // 2. æ›´æ–°è»Œè·¡
            drawTrack(degrees);

            // 3. æ›´æ–°æ•¸å­—é¡¯ç¤º (åƒ…åœ¨éæŒ‘æˆ°æ¨¡å¼ä¸‹)
            if (!isChallengeMode) {
                const kg = Math.floor(grams / 1000);
                const g = grams % 1000;
                digitalKgDisplay.textContent = `${kg} å…¬æ–¤`;
                digitalGramDisplay.textContent = `${g} å…¬å…‹`;
            }
        }
        
        // --- æ‹–æ›³åŠŸèƒ½ (ç ç¢¼æ¨¡å¼) ---
        
        function recalculateTotalWeight() {
            let totalWeight = 0;
            const weightsOnScale = onScaleArea.querySelectorAll('.draggable-weight');
            weightsOnScale.forEach(weight => {
                totalWeight += parseInt(weight.dataset.weight || '0', 10);
            });
            updateNeedleAndDisplay(totalWeight);
        }

        function startDrag(e) {
            // æŒ‘æˆ°æ¨¡å¼ä¸­ç¦æ­¢æ‹–æ›³
            if (isChallengeMode) {
                e.preventDefault();
                return;
            }
            draggedItem = e.target.closest('.draggable-weight');
            if (!draggedItem) return;
            
            const clone = draggedItem.cloneNode(true);
            clone.style.position = 'absolute';
            clone.style.zIndex = '1000';
            document.body.appendChild(clone);
            clone.classList.add('dragging');
            
            if (weightsHome.contains(draggedItem)) {
                draggedItem.style.visibility = 'hidden';
            } else if (onScaleArea.contains(draggedItem)) {
                draggedItem.remove();
            }

            draggedItem = clone;
            
            moveDrag(e); 
            
            document.addEventListener('mousemove', moveDrag);
            document.addEventListener('mouseup', endDrag);
            document.addEventListener('touchmove', moveDrag, { passive: false });
            document.addEventListener('touchend', endDrag);
            e.preventDefault();
        }

        function moveDrag(e) {
            if (!draggedItem) return;
            e.preventDefault();
            
            const clientX = e.clientX || (e.touches && e.touches[0].clientX);
            const clientY = e.clientY || (e.touches && e.touches[0].clientY);

            draggedItem.style.left = `${clientX - draggedItem.offsetWidth / 2}px`;
            draggedItem.style.top = `${clientY - draggedItem.offsetHeight / 2}px`;
        }

        function endDrag(e) {
            if (!draggedItem) return;

            // ä¿®æ­£ï¼šæš«æ™‚éš±è—ï¼Œä»¥æ­£ç¢ºåµæ¸¬ dropTarget
            draggedItem.style.display = 'none';
            const clientX = e.clientX || (e.changedTouches && e.changedTouches[0].clientX);
            const clientY = e.clientY || (e.changedTouches && e.changedTouches[0].clientY);
            const dropTarget = document.elementFromPoint(clientX, clientY);
            draggedItem.style.display = 'flex'; 
            
            // æª¢æŸ¥æ˜¯å¦æ”¾ç½®åœ¨ onScaleArea
            if (onScaleArea.contains(dropTarget) || dropTarget === onScaleArea) {
                draggedItem.style.position = 'static'; 
                draggedItem.classList.add('on-scale'); 
                onScaleArea.appendChild(draggedItem);
                playSound('click');
            } else {
                draggedItem.remove();
            }
            
            // é¡¯ç¤ºç ç¢¼å€çš„åŸå§‹é …ç›®
            // ä¿®æ­£ï¼šè‡ªè£½ç ç¢¼æ²’æœ‰åŸå§‹é …ç›®
            if (draggedItem && !draggedItem.classList.contains('custom-weight')) {
                const originalWeight = weightsHome.querySelector(`[data-weight="${draggedItem.dataset.weight}"]`);
                if (originalWeight) {
                    originalWeight.style.visibility = 'visible';
                }
            }

            // æ¸…ç†
            draggedItem.classList.remove('dragging');
            draggedItem = null;
            document.removeEventListener('mousemove', moveDrag);
            document.removeEventListener('mouseup', endDrag);
            document.removeEventListener('touchmove', moveDrag);
            document.removeEventListener('touchend', endDrag);

            recalculateTotalWeight(); // é‡æ–°è¨ˆç®—ç¸½é‡é‡
            
            // å„²å­˜è‡ªè£½ç ç¢¼ (å¦‚æœæ˜¯å¾ç§¤ç›¤æ‹–æ›³åˆ°ç§¤ç›¤)
            if (onScaleArea.contains(dropTarget) || dropTarget === onScaleArea) {
                 saveCustomWeightsToStorage(); // ç¢ºä¿æ‹–æ›³å¾Œä¹Ÿå„²å­˜
            }
        }

        // --- æŒ‘æˆ°æ¨¡å¼ (è®€å–é‡é‡) ---

        function generateChallengeQuestions(num) {
            const questions = [];
            const maxMultiple = MAX_WEIGHT_GRAMS / 50; // 3000 / 50 = 60
            for (let i = 0; i < num; i++) {
                const randomMultiple = Math.floor(Math.random() * maxMultiple) + 1;
                const grams = randomMultiple * 50; 
                questions.push(grams);
            }
            return questions;
        }

        function startChallenge() {
            isChallengeMode = true;
            score = 0;
            currentQuestionIndex = 0;
            challengeQuestions = generateChallengeQuestions(3);
            
            appContainer.classList.add('challenge-mode-active');
            challengeBtn.classList.add('hidden');
            
            displayNextQuestion();
        }

        function displayNextQuestion() {
            if (currentQuestionIndex < challengeQuestions.length) {
                challengeTargetGrams = challengeQuestions[currentQuestionIndex];
                
                updateNeedleAndDisplay(0); 

                setTimeout(() => {
                    let currentAnimGrams = 0;
                    const finalGrams = challengeTargetGrams;
                    const increment = 10; 
                    const intervalTime = 5; 

                    if (currentAnimationInterval) {
                        clearInterval(currentAnimationInterval);
                    }

                    currentAnimationInterval = setInterval(() => {
                        currentAnimGrams += increment;

                        if (currentAnimGrams >= finalGrams) {
                            currentAnimGrams = finalGrams;
                            clearInterval(currentAnimationInterval);
                            currentAnimationInterval = null;
                            updateNeedleAndDisplay(finalGrams); 
                            
                            challengeKgInput.value = '';
                            challengeGInput.value = '';
                            feedbackMessage.classList.add('app-modal-hidden'); // éš±è—

                            submitAnswerBtn.classList.remove('hidden');
                        } else {
                            updateNeedleAndDisplay(currentAnimGrams); 
                        }
                    }, intervalTime);
                    
                }, 10); 

            } else {
                endChallenge();
            }
        }

        function submitAnswer() {
            const targetGrams = challengeTargetGrams;
            
            const userKg = parseInt(challengeKgInput.value || '0', 10);
            const userG = parseInt(challengeGInput.value || '0', 10);
            const userTotalGrams = (userKg * 1000) + userG;

            if (userTotalGrams === targetGrams) {
                score++;
                feedbackMessage.textContent = 'ç­”å°äº†ï¼';
                feedbackMessage.className = 'mt-4 text-center text-2xl font-bold text-green-600';
                playSound('correct');
                currentQuestionIndex++;
                submitAnswerBtn.classList.add('hidden');
                setTimeout(displayNextQuestion, 1500); 
            } else {
                feedbackMessage.textContent = 'å†è©¦è©¦çœ‹ï¼';
                feedbackMessage.className = 'mt-4 text-center text-2xl font-bold text-red-600';
                playSound('wrong');

                if (feedbackMessage.dataset.attempt === '1') {
                    const correctKg = Math.floor(targetGrams / 1000);
                    const correctG = targetGrams % 1000;
                    feedbackMessage.textContent = `å·®ä¸€é»é»ï¼ç­”æ¡ˆæ˜¯ ${correctKg} å…¬æ–¤ ${correctG} å…¬å…‹ã€‚`;
                    currentQuestionIndex++;
                    submitAnswerBtn.classList.add('hidden');
                    setTimeout(displayNextQuestion, 2500); 
                    feedbackMessage.dataset.attempt = '0';
                } else {
                    feedbackMessage.dataset.attempt = '1';
                }
            }
            feedbackMessage.classList.remove('app-modal-hidden'); // é¡¯ç¤º
        }

        function endChallenge() {
            isChallengeMode = false;
            
            appContainer.classList.remove('challenge-mode-active');
            challengeBtn.classList.remove('hidden');
            submitAnswerBtn.classList.add('hidden');
            
            if (currentAnimationInterval) {
                clearInterval(currentAnimationInterval);
                currentAnimationInterval = null;
            }

            finalScore.textContent = score;
            totalQuestions.textContent = challengeQuestions.length;
            resultModal.classList.remove('app-modal-hidden');
            resultModal.classList.add('flex'); // é¡¯ç¤º

            if (score === challengeQuestions.length) {
                resultTitle.textContent = 'æ­å–œï¼å…¨éƒ¨ç­”å°ï¼ğŸ‰';
                playSound('success_jingle');
                launchConfetti();
            } else {
                resultTitle.textContent = 'æŒ‘æˆ°å®Œæˆï¼';
            }
            
            resetScaleToInitialState(false); 
        }

        // --- æ–°å¢ï¼šå»ºç«‹è‡ªè£½ç ç¢¼ (DOM å…ƒç´ ) ---
        function createCustomWeightElement(name, grams, imageUrl) {
            const newWeightDiv = document.createElement('div');
            newWeightDiv.classList.add('draggable-weight');
            newWeightDiv.classList.add('custom-weight'); // æ¨™è¨˜ç‚ºè‡ªè£½
            newWeightDiv.dataset.weight = grams;
            newWeightDiv.title = `${name} (${grams}g)`;
            newWeightDiv.style.backgroundImage = `url(${imageUrl})`;
            
            const shortName = name.length > 5 ? name.substring(0, 4) + '...' : name;
            newWeightDiv.textContent = `${shortName} ${grams}g`;
            newWeightDiv.style.fontSize = '0.6rem'; 
            newWeightDiv.style.textAlign = 'center';

            weightsHome.appendChild(newWeightDiv);
        }

        // --- æ–°å¢ï¼šå„²å­˜è‡ªè£½ç ç¢¼åˆ° localStorage ---
        function saveCustomWeightsToStorage() {
            const weights = [];
            // ä¿®æ­£ï¼šåŒæ™‚é¸å–ç§¤ç›¤ä¸Šå’Œç ç¢¼å€çš„è‡ªè£½ç ç¢¼
            const onScaleWeights = onScaleArea.querySelectorAll('.custom-weight');
            const inHomeWeights = weightsHome.querySelectorAll('.custom-weight');

            const allCustomWeights = new Map(); // ç”¨ Map é¿å…é‡è¤‡å„²å­˜
            
            inHomeWeights.forEach(weightDiv => {
                const data = {
                    name: weightDiv.title.split(' (')[0],
                    grams: weightDiv.dataset.weight,
                    imageUrl: weightDiv.style.backgroundImage.slice(5, -2) 
                };
                allCustomWeights.set(data.name + data.grams + data.imageUrl, data);
            });
            onScaleWeights.forEach(weightDiv => {
                 const data = {
                    name: weightDiv.title.split(' (')[0],
                    grams: weightDiv.dataset.weight,
                    imageUrl: weightDiv.style.backgroundImage.slice(5, -2) 
                };
                allCustomWeights.set(data.name + data.grams + data.imageUrl, data);
            });
            
            localStorage.setItem(CUSTOM_WEIGHTS_STORAGE_KEY, JSON.stringify(Array.from(allCustomWeights.values())));
        }

        // --- æ–°å¢ï¼šå¾ localStorage è¼‰å…¥è‡ªè£½ç ç¢¼ ---
        function loadCustomWeightsFromStorage() {
            const savedWeights = JSON.parse(localStorage.getItem(CUSTOM_WEIGHTS_STORAGE_KEY) || '[]');
            
            savedWeights.forEach(weight => {
                createCustomWeightElement(weight.name, weight.grams, weight.imageUrl);
            });
        }

        // --- é‡ç½®åŠŸèƒ½ ---
        function resetScaleToInitialState(resetUI = true) {
            onScaleArea.innerHTML = '';
            recalculateTotalWeight(); 
            
            if (resetUI) {
                isChallengeMode = false;
                appContainer.classList.remove('challenge-mode-active');
                challengeBtn.classList.remove('hidden');
                submitAnswerBtn.classList.add('hidden');
                feedbackMessage.classList.add('app-modal-hidden'); // éš±è—
                
                resultModal.classList.add('app-modal-hidden');
                resultModal.classList.remove('flex'); 
                
                if (currentAnimationInterval) {
                    clearInterval(currentAnimationInterval);
                    currentAnimationInterval = null;
                }
            }
            digitalKgDisplay.textContent = `0 å…¬æ–¤`;
            digitalGramDisplay.textContent = `0 å…¬å…‹`;
        }
        
        // --- è‡ªè£½ç ç¢¼åŠŸèƒ½ ---
        
        // é¡¯ç¤ºå½ˆçª—
        addWeightBtn.addEventListener('click', () => {
            customWeightName.value = '';
            customWeightGrams.value = '';
            customWeightImageInput.value = null;
            imagePreview.style.backgroundImage = 'none';
            imagePreviewUrl = null;
            
            customWeightModal.classList.remove('app-modal-hidden');
            customWeightModal.classList.add('flex'); // é¡¯ç¤º
        });

        // é—œé–‰å½ˆçª—
        closeModalBtn.addEventListener('click', () => {
            customWeightModal.classList.add('app-modal-hidden');
            customWeightModal.classList.remove('flex'); // éš±è—
        });

        // åœ–ç‰‡é è¦½
        customWeightImageInput.addEventListener('change', (e) => {
            const file = e.target.files[0];
            if (file) {
                const reader = new FileReader();
                reader.onload = (event) => {
                    imagePreviewUrl = event.target.result;
                    imagePreview.style.backgroundImage = `url(${imagePreviewUrl})`;
                };
                reader.readAsDataURL(file);
            }
        });

        // å„²å­˜ç ç¢¼ (å·²ä¿®æ”¹)
        saveWeightBtn.addEventListener('click', () => {
            const name = customWeightName.value || 'ç‰©å“';
            const grams = parseInt(customWeightGrams.value || '0', 10);

            if (grams <= 0) {
                feedbackMessage.textContent = 'è«‹è¼¸å…¥å¤§æ–¼ 0 çš„é‡é‡';
                feedbackMessage.className = 'mt-4 text-center text-lg font-bold text-red-600';
                feedbackMessage.classList.remove('app-modal-hidden'); // é¡¯ç¤º
                setTimeout(() => feedbackMessage.classList.add('app-modal-hidden'), 2000);
                return;
            }
            if (!imagePreviewUrl) {
                feedbackMessage.textContent = 'è«‹ä¸Šå‚³ä¸€å¼µåœ–ç‰‡';
                feedbackMessage.className = 'mt-4 text-center text-lg font-bold text-red-600';
                feedbackMessage.classList.remove('app-modal-hidden'); // é¡¯ç¤º
                setTimeout(() => feedbackMessage.classList.add('app-modal-hidden'), 2000);
                return;
            }

            // å‘¼å«æ–°å‡½æ•¸ä¾†å»ºç«‹å…ƒç´ 
            createCustomWeightElement(name, grams, imagePreviewUrl);
            
            // å‘¼å«æ–°å‡½æ•¸ä¾†å„²å­˜
            saveCustomWeightsToStorage();

            // é—œé–‰å½ˆçª—
            customWeightModal.classList.add('app-modal-hidden');
            customWeightModal.classList.remove('flex'); // éš±è—
        });
        
        // --- æ–°å¢ï¼šæ¸…é™¤è‡ªè£½ç ç¢¼çš„äº‹ä»¶ ---
        clearCustomWeightsBtn.addEventListener('click', () => {
            // 1. å¾ localStorage ç§»é™¤
            localStorage.removeItem(CUSTOM_WEIGHTS_STORAGE_KEY);
            
            // 2. å¾ DOM ç§»é™¤
            const customWeights = document.querySelectorAll('.custom-weight'); // å¾ç§¤ç›¤å’Œç ç¢¼å€éƒ½ç§»é™¤
            customWeights.forEach(weightDiv => {
                weightDiv.remove();
            });
            
            // 3. æç¤ºä½¿ç”¨è€…
            feedbackMessage.textContent = 'å·²æ¸…é™¤æ‰€æœ‰è‡ªè£½ç ç¢¼';
            feedbackMessage.className = 'mt-4 text-center text-lg font-bold text-blue-600';
            feedbackMessage.classList.remove('app-modal-hidden'); // é¡¯ç¤º
            setTimeout(() => feedbackMessage.classList.add('app-modal-hidden'), 2000);
            
            // 4. é‡ç®—é‡é‡
            recalculateTotalWeight();
        });


        // --- äº‹ä»¶ç›£è½å™¨ ---
        
        weightsHome.addEventListener('mousedown', startDrag);
        weightsHome.addEventListener('touchstart', startDrag, { passive: false });
        
        onScaleArea.addEventListener('mousedown', startDrag);
        onScaleArea.addEventListener('touchstart', startDrag, { passive: false });

        challengeBtn.addEventListener('click', startChallenge);
        submitAnswerBtn.addEventListener('click', submitAnswer);
        resetBtn.addEventListener('click', () => resetScaleToInitialState(true));

        soundToggle.addEventListener('change', (e) => {
            useSound = e.target.checked;
            if (useSound) {
                createAudioContext();
            }
        });
        
        trackToggle.addEventListener('change', (e) => {
            useTrack = e.target.checked;
            updateNeedleAndDisplay(currentGrams); 
        });

        // å½ˆçª—
        helpBtn.addEventListener('click', () => {
            helpModal.classList.remove('app-modal-hidden');
            helpModal.classList.add('flex'); // é¡¯ç¤º
        });
        closeHelpModalBtn.addEventListener('click', () => {
            helpModal.classList.add('app-modal-hidden');
            helpModal.classList.remove('flex'); // éš±è—
        });
        closeResultModalBtn.addEventListener('click', () => {
            resultModal.classList.add('app-modal-hidden');
            resultModal.classList.remove('flex'); // éš±è—
            confettiContainer.innerHTML = '';
            resetScaleToInitialState(true); 
        });

        // --- åˆå§‹åŒ– ---
        drawScaleMarks(); 
        updateNeedleAndDisplay(0); 

        document.body.addEventListener('click', createAudioContext, { once: true });
        document.body.addEventListener('touchstart', createAudioContext, { once: true });


        // --- PWA Service Worker è¨»å†Š ---
        if ('serviceWorker' in navigator) {
            window.addEventListener('load', () => {
                navigator.serviceWorker.register('./sw.js')
                    .then(registration => {
                        console.log('ServiceWorker è¨»å†ŠæˆåŠŸ: ', registration);
                    })
                    .catch(error => {
                        console.log('ServiceWorker è¨»å†Šå¤±æ•—: ', error);
                    });
            });
        }
        // --- PWA è¨»å†ŠçµæŸ ---


        // --- è¼‰å…¥å„²å­˜çš„ç ç¢¼ ---
        loadCustomWeightsFromStorage();

    }); // --- DOMContentLoaded çµæŸ ---
    </script>
</body>
</html>

